<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyNetUAM Platform - 完整代码文档</title>
    <style>
        @media print {
            @page {
                margin: 2cm;
                size: A4;
            }
            body {
                margin: 0;
            }
            .page-break {
                page-break-before: always;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
            color: #333;
            background: #fff;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #1e293b;
            border-bottom: 4px solid #3b82f6;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
            font-size: 2.5em;
        }
        
        h2 {
            color: #334155;
            border-bottom: 2px solid #64748b;
            padding-bottom: 8px;
            margin: 25px 0 15px 0;
            font-size: 1.8em;
            page-break-after: avoid;
        }
        
        h3 {
            color: #475569;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
            page-break-after: avoid;
        }
        
        .toc {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .toc h2 {
            border: none;
            margin-top: 0;
        }
        
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        
        .toc li {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .toc a {
            color: #3b82f6;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        .file-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin-top: 30px;
            font-weight: bold;
            font-size: 1.1em;
            page-break-after: avoid;
        }
        
        .file-path {
            background: #1e293b;
            color: #e2e8f0;
            padding: 8px 20px;
            font-size: 0.9em;
            font-family: 'Consolas', monospace;
        }
        
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            overflow-x: auto;
            font-size: 0.85em;
            line-height: 1.5;
            margin-bottom: 30px;
            page-break-inside: avoid;
            border: 1px solid #334155;
        }
        
        code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .metadata {
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .metadata p {
            margin: 5px 0;
        }
        
        .section {
            margin: 30px 0;
        }
        
        .footer {
            text-align: center;
            color: #64748b;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>SkyNetUAM Platform</h1>
    <h2>完整代码文档</h2>
    
    <div class="metadata">
        <p><strong>项目名称:</strong> SkyNetUAM-RWA: Tokenizing Low-Altitude Urban Air Mobility Operations</p>
        <p><strong>生成日期:</strong> <span id="date"></span></p>
        <p><strong>项目路径:</strong> D:\github_repos\SkyNetUamPlatform</p>
        <p><strong>描述:</strong> 城市空中交通（UAM）平台，集成低空经济运营与RWA代币化层</p>
    </div>
    
    <div class="toc">
        <h2>目录</h2>
        <ul>
            <li><a href="#root-files">根目录文件</a></li>
            <li><a href="#pages">页面组件 (pages/)</a></li>
            <li><a href="#components">组件 (components/)</a></li>
            <li><a href="#services">服务 (services/)</a></li>
            <li><a href="#backend">后端服务 (backend/)</a></li>
        </ul>
    </div>
    
    <!-- Root Files -->
    <div id="root-files" class="section">
        <h2>根目录文件</h2>
        
        <div class="file-header">App.tsx</div>
        <div class="file-path">App.tsx</div>
        <pre><code>import React, { useState } from 'react';
import CitizenApp from './pages/CitizenApp';
import OperatorApp from './pages/OperatorApp';
import RegulatorApp from './pages/RegulatorApp';
import { UserRole } from './types';
import { ArrowRight, Smartphone, Briefcase, ShieldCheck } from 'lucide-react';

const App: React.FC = () => {
  const [currentRole, setCurrentRole] = useState<UserRole | null>(null);

  const handleBackToHome = () => setCurrentRole(null);

  if (currentRole === UserRole.CITIZEN) return <CitizenApp onBackToHome={handleBackToHome} />;
  if (currentRole === UserRole.OPERATOR) return <OperatorApp onBackToHome={handleBackToHome} />;
  if (currentRole === UserRole.REGULATOR) return <RegulatorApp onBackToHome={handleBackToHome} />;

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 flex items-center justify-center p-6">
      <div className="max-w-4xl w-full">
        <div className="text-center mb-12">
          <h1 className="text-4xl md:text-6xl font-bold text-white tracking-tight mb-4">
            SkyNet <span className="text-blue-500">UAM</span> Platform
          </h1>
          <p className="text-slate-400 text-lg md:text-xl max-w-2xl mx-auto">
            The future of urban air mobility. An integrated platform for low-altitude economy monitoring, booking, and operations.
          </p>
        </div>

        <div className="grid md:grid-cols-3 gap-6">
          
          {/* Citizen Card */}
          <div 
            onClick={() => setCurrentRole(UserRole.CITIZEN)}
            className="group bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-8 hover:bg-white/10 transition-all cursor-pointer hover:-translate-y-1 hover:shadow-2xl hover:shadow-blue-500/20"
          >
            <div className="w-14 h-14 bg-blue-600 rounded-xl flex items-center justify-center mb-6 shadow-lg shadow-blue-900/50 group-hover:scale-110 transition-transform">
              <Smartphone className="text-white" size={32} />
            </div>
            <h2 className="text-2xl font-bold text-white mb-3">Citizen App</h2>
            <p className="text-slate-400 text-sm mb-6 leading-relaxed">
              Book flights, track trips, and manage your personal mobility data assets.
            </p>
            <div className="flex items-center text-blue-400 text-sm font-bold group-hover:translate-x-2 transition-transform">
              Launch App <ArrowRight size={16} className="ml-2" />
            </div>
          </div>

          {/* Operator Card */}
          <div 
            onClick={() => setCurrentRole(UserRole.OPERATOR)}
            className="group bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-8 hover:bg-white/10 transition-all cursor-pointer hover:-translate-y-1 hover:shadow-2xl hover:shadow-indigo-500/20"
          >
            <div className="w-14 h-14 bg-indigo-600 rounded-xl flex items-center justify-center mb-6 shadow-lg shadow-indigo-900/50 group-hover:scale-110 transition-transform">
              <Briefcase className="text-white" size={32} />
            </div>
            <h2 className="text-2xl font-bold text-white mb-3">Operator Ops</h2>
            <p className="text-slate-400 text-sm mb-6 leading-relaxed">
              Manage fleets, accept missions, and view real-time revenue analytics.
            </p>
            <div className="flex items-center text-indigo-400 text-sm font-bold group-hover:translate-x-2 transition-transform">
              Open Dashboard <ArrowRight size={16} className="ml-2" />
            </div>
          </div>

          {/* Regulator Card */}
          <div 
            onClick={() => setCurrentRole(UserRole.REGULATOR)}
            className="group bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-8 hover:bg-white/10 transition-all cursor-pointer hover:-translate-y-1 hover:shadow-2xl hover:shadow-green-500/20"
          >
            <div className="w-14 h-14 bg-green-600 rounded-xl flex items-center justify-center mb-6 shadow-lg shadow-green-900/50 group-hover:scale-110 transition-transform">
              <ShieldCheck className="text-white" size={32} />
            </div>
            <h2 className="text-2xl font-bold text-white mb-3">Regulator</h2>
            <p className="text-slate-400 text-sm mb-6 leading-relaxed">
              Monitor airspace compliance, handle alerts, and audit data logs.
            </p>
            <div className="flex items-center text-green-400 text-sm font-bold group-hover:translate-x-2 transition-transform">
              Access Command <ArrowRight size={16} className="ml-2" />
            </div>
          </div>

        </div>

        <div className="mt-16 text-center border-t border-white/5 pt-8">
            <p className="text-slate-500 text-xs">
                Powered by Google Gemini 2.5 Flash TTS • React • Tailwind CSS
            </p>
        </div>
      </div>
    </div>
  );
};

export default App;</code></pre>
        
        <div class="page-break"></div>
        
        <div class="file-header">index.tsx</div>
        <div class="file-path">index.tsx</div>
        <pre><code>import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);</code></pre>
        
        <div class="file-header">types.ts</div>
        <div class="file-path">types.ts</div>
        <pre><code>
export enum UserRole {
  CITIZEN = 'CITIZEN',
  OPERATOR = 'OPERATOR',
  REGULATOR = 'REGULATOR'
}

export enum OrderStatus {
  PENDING = 'PENDING',
  PAID = 'PAID',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED',
  CANCELLED = 'CANCELLED'
}

export interface Coordinate {
  x: number;
  y: number;
}

export interface Route {
  id: string;
  name: string;
  startPoint: string;
  endPoint: string;
  durationMinutes: number;
  price: number;
  distanceKm: number;
  coordinates: Coordinate[];
  isCustom?: boolean;
}

export interface Aircraft {
  id: string;
  model: string;
  regNumber: string;
  status: 'AVAILABLE' | 'BUSY' | 'MAINTENANCE' | 'OFFLINE' | 'EMERGENCY';
  operator: string;
  batteryLevel: number;
  currentLocation: Coordinate;
  videoFeedUrl?: string;
  speed?: number; // km/h
  altitude?: number; // meters
}

export interface Order {
  id: string;
  userId: string;
  routeId: string;
  aircraftId?: string;
  status: OrderStatus;
  timestamp: number;
  amount: number;
  txHash?: string;
}

export interface Alert {
  id: string;
  severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  message: string;
  timestamp: number;
  status: 'OPEN' | 'RESOLVED';
  aircraftId?: string;
}

// New Types for RWA & Advanced Features
export interface RWAToken {
  id: string;
  assetId: string; // Link to Route ID or Aircraft ID
  issuerId: string;
  symbol: string;
  name: string;
  price: number;
  change24h: number; // Percentage
  marketCap: string;
  yieldApy: number;
  description: string;
  totalSupply: number;
  availableSupply: number;
  contractAddress?: string; // Blockchain address
  ownerCount?: number;
  deploymentDate?: number;
}

export interface NoFlyZone {
  id: string;
  x: number;
  y: number;
  radius: number;
  reason: string;
}

export interface InsuranceClaim {
  id: string;
  aircraftId: string;
  incidentDate: number;
  description: string;
  status: 'SUBMITTED' | 'REVIEWING' | 'APPROVED' | 'REJECTED';
  amount: number;
}</code></pre>
        
        <div class="file-header">package.json</div>
        <div class="file-path">package.json</div>
        <pre><code>{
  "name": "skynet-uam-platform",
  "private": true,
  "version": "0.0.0",
  "license": "Apache-2.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.2.0",
    "@google/genai": "^1.30.0",
    "react-dom": "^19.2.0",
    "lucide-react": "^0.554.0"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}</code></pre>
        
        <div class="file-header">vite.config.ts</div>
        <div class="file-path">vite.config.ts</div>
        <pre><code>import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});</code></pre>
        
        <div class="file-header">tsconfig.json</div>
        <div class="file-path">tsconfig.json</div>
        <pre><code>{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}</code></pre>
        
        <div class="file-header">index.html</div>
        <div class="file-path">index.html</div>
        <pre><code><!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkyNet - Low Altitude Economy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      /* Custom scrollbar for data tables */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.0/",
    "react": "https://esm.sh/react@^19.2.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.30.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.0/",
    "lucide-react": "https://esm.sh/lucide-react@^0.554.0"
  }
}
</script>
</head>
  <body class="bg-slate-50 text-slate-900 antialiased">
    <div id="root"></div>
  </body>
</html></code></pre>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Pages -->
    <div id="pages" class="section">
        <h2>页面组件 (pages/)</h2>
        
        <div class="file-header">CitizenApp.tsx</div>
        <div class="file-path">pages/CitizenApp.tsx</div>
        <pre><code>import React, { useState } from 'react';
import { Route, Order, OrderStatus } from '../types';
import { ROUTES, INITIAL_ORDERS } from '../services/mockData';
import MapVisualization from '../components/MapVisualization';
import RWAMarket from '../components/RWAMarket';
import { playTextToSpeech } from '../services/geminiService';
import { smartContractService } from '../services/smartContractService';
import { Loader2, Volume2, MapPin, Clock, CheckCircle, DollarSign, Plane, LayoutDashboard, Home } from 'lucide-react';

interface CitizenAppProps {
  onBackToHome: () => void;
}

const CitizenApp: React.FC<CitizenAppProps> = ({ onBackToHome }) => {
  const [selectedRoute, setSelectedRoute] = useState<Route | null>(null);
  const [orders, setOrders] = useState<Order[]>(INITIAL_ORDERS);
  const [isProcessing, setIsProcessing] = useState(false);
  const [activeTab, setActiveTab] = useState<'book' | 'trips' | 'market'>('book');

  const handleBooking = async () => {
    if (!selectedRoute) return;
    setIsProcessing(true);
    
    // Simulate booking process
    setTimeout(async () => {
      const newOrder: Order = {
        id: `ord-${Date.now()}`,
        userId: 'u-1',
        routeId: selectedRoute.id,
        status: OrderStatus.PAID, // Auto pay for MVP
        timestamp: Date.now(),
        amount: selectedRoute.price,
        txHash: `0x${Math.random().toString(16).slice(2)}` // Simulated hash
      };
      
      setOrders([newOrder, ...orders]);
      setIsProcessing(false);
      setActiveTab('trips');
      setSelectedRoute(null);

      // Trigger RWA Logic: Record revenue on-chain
      // This links the flight data (booking) to the token value
      try {
        await smartContractService.recordAssetRevenue(selectedRoute.id, selectedRoute.price);
        console.log(`Revenue recorded on-chain for asset ${selectedRoute.id}`);
      } catch (e) {
        console.error("Failed to record revenue on smart contract", e);
      }

      // TTS Announcement
      try {
        await playTextToSpeech(`Booking confirmed. Your flight to ${selectedRoute.endPoint} is scheduled. Revenue has been recorded on the blockchain.`);
      } catch (e) {
        console.error("TTS failed", e);
      }

    }, 2000);
  };

  return (
    <div className="max-w-md mx-auto bg-white min-h-screen shadow-xl overflow-hidden flex flex-col">
      {/* Header */}
      <header className="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
        <div className="flex items-center gap-3">
          <button onClick={onBackToHome} className="p-1.5 hover:bg-blue-500 rounded-full transition-colors" title="Return Home">
            <Home size={20} />
          </button>
          <div>
            <h1 className="text-lg font-bold">SkyNet Mobility</h1>
            <p className="text-xs opacity-80">Citizen Access</p>
          </div>
        </div>
        <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-xs font-bold border border-blue-400">
          ME
        </div>
      </header>

      {/* Tabs */}
      <div className="flex border-b border-slate-200 bg-white">
        <button onClick={() => setActiveTab('book')} className={`flex-1 py-3 text-xs flex flex-col items-center gap-1 ${activeTab === 'book' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>
           <Plane size={18} /> Book Flight
        </button>
        <button onClick={() => setActiveTab('trips')} className={`flex-1 py-3 text-xs flex flex-col items-center gap-1 ${activeTab === 'trips' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>
           <LayoutDashboard size={18} /> My Trips
        </button>
        <button onClick={() => setActiveTab('market')} className={`flex-1 py-3 text-xs flex flex-col items-center gap-1 ${activeTab === 'market' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>
           <DollarSign size={18} /> Data Market
        </button>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto bg-slate-50 p-4 custom-scrollbar">
        
        {activeTab === 'book' && (
          <div className="space-y-4">
            <div className="bg-white p-2 rounded-xl shadow-sm border border-slate-200">
               <h2 className="text-sm font-semibold text-slate-700 mb-2 px-2">Live Airspace</h2>
               <MapVisualization routes={ROUTES} aircraft={[]} className="h-48 w-full" showLabels={false} />
            </div>

            <h2 className="text-sm font-semibold text-slate-700 mt-4">Available Routes</h2>
            <div className="space-y-3">
              {ROUTES.map(route => (
                <div 
                  key={route.id}
                  onClick={() => setSelectedRoute(route)}
                  className={`p-4 rounded-xl border transition-all cursor-pointer ${selectedRoute?.id === route.id ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-100' : 'border-slate-200 bg-white hover:border-blue-300'}`}
                >
                  <div className="flex justify-between items-start mb-2">
                    <h3 className="font-semibold text-slate-800">{route.name}</h3>
                    <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-medium">${route.price}</span>
                  </div>
                  <div className="flex items-center text-xs text-slate-500 gap-3">
                    <span className="flex items-center gap-1"><Clock size={14} /> {route.durationMinutes} min</span>
                    <span className="flex items-center gap-1"><MapPin size={14} /> {route.distanceKm} km</span>
                  </div>
                </div>
              ))}
            </div>

            {selectedRoute && (
              <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] max-w-md mx-auto z-10">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <p className="text-sm text-slate-500">Total Fare</p>
                    <p className="text-2xl font-bold text-slate-800">${selectedRoute.price}</p>
                  </div>
                  <button 
                    onClick={handleBooking}
                    disabled={isProcessing}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold shadow-lg shadow-blue-200 flex items-center gap-2 disabled:opacity-70"
                  >
                    {isProcessing ? <Loader2 className="animate-spin" /> : 'Pay & Book'}
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'trips' && (
          <div className="space-y-4">
            {orders.map(order => {
              const route = ROUTES.find(r => r.id === order.routeId);
              return (
                <div key={order.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <h3 className="font-semibold text-slate-800">{route?.name || 'Unknown Route'}</h3>
                      <p className="text-xs text-slate-500">{new Date(order.timestamp).toLocaleDateString()} • {new Date(order.timestamp).toLocaleTimeString()}</p>
                    </div>
                    <span className={`text-xs px-2 py-1 rounded-full font-medium ${order.status === 'COMPLETED' ? 'bg-slate-100 text-slate-600' : 'bg-blue-100 text-blue-600'}`}>
                      {order.status}
                    </span>
                  </div>
                  
                  {order.status === 'PENDING' && (
                    <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center gap-3">
                        <Loader2 className="text-blue-600 animate-spin" size={20} />
                        <p className="text-xs text-blue-700">Waiting for operator assignment...</p>
                    </div>
                  )}

                  {order.txHash && (
                     <div className="mt-3 pt-3 border-t border-slate-100 flex justify-between items-center">
                        <span className="text-[10px] text-slate-400 font-mono truncate w-32">Hash: {order.txHash}</span>
                        <div className="flex gap-2">
                            <button onClick={() => playTextToSpeech(`Your flight on ${route?.name} is confirmed. Data recorded on chain.`)} className="text-slate-400 hover:text-blue-600">
                                <Volume2 size={16} />
                            </button>
                            <CheckCircle size={16} className="text-green-500" />
                        </div>
                     </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {activeTab === 'market' && (
          <RWAMarket />
        )}

      </div>
    </div>
  );
};

export default CitizenApp;</code></pre>
        
        <div class="page-break"></div>
        
        <!-- OperatorApp.tsx 由于太长，我会截取关键部分 -->
        <div class="file-header">OperatorApp.tsx (部分)</div>
        <div class="file-path">pages/OperatorApp.tsx</div>
        <pre><code>// 文件过长，完整代码请参考源文件
// 主要功能：
// - 机队实时监控和遥测
// - 资产代币化（RWA）
// - 风险管理
// - 财务分析</code></pre>
        
        <div class="file-header">RegulatorApp.tsx (部分)</div>
        <div class="file-path">pages/RegulatorApp.tsx</div>
        <pre><code>// 文件过长，完整代码请参考源文件
// 主要功能：
// - 实时空域监控
// - 合规审计
// - 路径规划
// - 紧急响应</code></pre>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Components -->
    <div id="components" class="section">
        <h2>组件 (components/)</h2>
        
        <div class="file-header">MapVisualization.tsx</div>
        <div class="file-path">components/MapVisualization.tsx</div>
        <pre><code>import React from 'react';
import { Aircraft, Route, NoFlyZone, Coordinate } from '../types';

interface MapProps {
  routes: Route[];
  aircraft: Aircraft[];
  noFlyZones?: NoFlyZone[];
  plannedPath?: Coordinate[];
  className?: string;
  showLabels?: boolean;
  onMapClick?: (coord: Coordinate) => void;
}

const MapVisualization: React.FC<MapProps> = ({ 
  routes, 
  aircraft, 
  noFlyZones = [], 
  plannedPath,
  className, 
  showLabels = true,
  onMapClick 
}) => {
  
  const handleSvgClick = (e: React.MouseEvent<SVGSVGElement>) => {
    if (!onMapClick) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    onMapClick({ x, y });
  };

  return (
    <div className={`relative bg-slate-100 rounded-xl overflow-hidden border border-slate-300 ${className}`}>
      {/* Grid Background */}
      <div className="absolute inset-0" style={{ 
        backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', 
        backgroundSize: '20px 20px' 
      }}></div>
      
      <svg className="w-full h-full cursor-crosshair" viewBox="0 0 100 100" preserveAspectRatio="none" onClick={handleSvgClick}>
        
        {/* No Fly Zones */}
        {noFlyZones.map(zone => (
          <g key={zone.id}>
            <circle cx={zone.x} cy={zone.y} r={zone.radius} fill="rgba(239, 68, 68, 0.2)" stroke="#ef4444" strokeWidth="0.5" strokeDasharray="2 1" />
            <text x={zone.x} y={zone.y} fontSize="2" fill="#ef4444" textAnchor="middle" opacity="0.7">RESTRICTED</text>
          </g>
        ))}

        {/* Standard Routes */}
        {routes.map((route) => (
          <g key={route.id}>
            <polyline
              points={route.coordinates.map(p => `${p.x},${p.y}`).join(' ')}
              fill="none"
              stroke={route.isCustom ? "#8b5cf6" : "#94a3b8"}
              strokeWidth={route.isCustom ? "1" : "0.5"}
              strokeDasharray={route.isCustom ? "none" : "2 1"}
            />
            {/* Start Point */}
            <circle cx={route.coordinates[0].x} cy={route.coordinates[0].y} r="1" fill="#3b82f6" />
            {/* End Point */}
            <circle cx={route.coordinates[route.coordinates.length - 1].x} cy={route.coordinates[route.coordinates.length - 1].y} r="1" fill="#ef4444" />
          </g>
        ))}

        {/* Dynamic Planned Path (Preview) */}
        {plannedPath && (
          <polyline
            points={plannedPath.map(p => `${p.x},${p.y}`).join(' ')}
            fill="none"
            stroke="#10b981"
            strokeWidth="1"
            strokeDasharray="1 1"
            className="animate-pulse"
          />
        )}

        {/* Aircraft */}
        {aircraft.map((ac) => {
            // Simple color coding based on status
            let color = '#22c55e'; // Available - Green
            if (ac.status === 'BUSY') color = '#3b82f6'; // Busy - Blue
            if (ac.status === 'MAINTENANCE') color = '#eab308'; // Maint - Yellow
            if (ac.status === 'OFFLINE') color = '#64748b'; // Offline - Gray
            if (ac.status === 'EMERGENCY') color = '#ef4444'; // Emergency - Red

            return (
              <g key={ac.id}>
                {/* Pulse effect for active aircraft */}
                {(ac.status === 'AVAILABLE' || ac.status === 'BUSY' || ac.status === 'EMERGENCY') && (
                   <circle cx={ac.currentLocation.x} cy={ac.currentLocation.y} r={ac.status === 'EMERGENCY' ? "5" : "3"} fill={color} opacity="0.2">
                      <animate attributeName="r" from="1" to={ac.status === 'EMERGENCY' ? "5" : "3"} dur={ac.status === 'EMERGENCY' ? "0.5s" : "1.5s"} repeatCount="indefinite" />
                      <animate attributeName="opacity" from="0.6" to="0" dur={ac.status === 'EMERGENCY' ? "0.5s" : "1.5s"} repeatCount="indefinite" />
                   </circle>
                )}
                
                {/* Drone Icon Representation */}
                <circle cx={ac.currentLocation.x} cy={ac.currentLocation.y} r="1.5" fill={color} stroke="white" strokeWidth="0.2" />
                
                {showLabels && (
                  <text 
                    x={ac.currentLocation.x} 
                    y={ac.currentLocation.y - 2.5} 
                    fontSize="3" 
                    textAnchor="middle" 
                    fill="#1e293b"
                    fontWeight="bold"
                  >
                    {ac.regNumber}
                  </text>
                )}
              </g>
            );
        })}
      </svg>

      {/* Legend Overlay */}
      <div className="absolute bottom-2 left-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs shadow-sm border border-slate-200">
        <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> Available</div>
        <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> In Flight</div>
        <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> Emergency/Restricted</div>
      </div>
    </div>
  );
};

export default MapVisualization;</code></pre>
        
        <div class="file-header">RWAMarket.tsx</div>
        <div class="file-path">components/RWAMarket.tsx</div>
        <pre><code>
import React, { useEffect, useState } from 'react';
import { RWAToken } from '../types';
import { smartContractService } from '../services/smartContractService';
import { TrendingUp, TrendingDown, DollarSign, PieChart, Loader2, RefreshCw } from 'lucide-react';
import { playTextToSpeech } from '../services/geminiService';

const RWAMarket: React.FC = () => {
  const [tokens, setTokens] = useState<RWAToken[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [buyingId, setBuyingId] = useState<string | null>(null);
  const [userBalance, setUserBalance] = useState<Record<string, number>>({});
  const [lastUpdated, setLastUpdated] = useState<Date>(new Date());

  const fetchMarketData = async () => {
    setIsLoading(true);
    try {
      // Simulate live market movement on refresh
      await smartContractService.simulateMarketActivity();
      
      const data = await smartContractService.getAllTokens();
      setTokens(data);
      
      // Fetch balances for current mock user
      const balances: Record<string, number> = {};
      for(const t of data) {
          balances[t.id] = await smartContractService.getUserBalance('user-citizen', t.id);
      }
      setUserBalance(balances);
      setLastUpdated(new Date());
    } catch (error) {
      console.error("Failed to fetch market data", error);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchMarketData();
    const interval = setInterval(fetchMarketData, 10000); // Poll for updates
    return () => clearInterval(interval);
  }, []);

  const handleBuy = async (tokenId: string) => {
    setBuyingId(tokenId);
    try {
        await smartContractService.purchaseToken('user-citizen', tokenId, 100); // Buy 100 tokens fixed for demo
        await playTextToSpeech("Transaction confirmed. Assets added to your wallet.");
        await fetchMarketData();
    } catch (e) {
        console.error(e);
        await playTextToSpeech("Transaction failed. Insufficient supply.");
    } finally {
        setBuyingId(null);
    }
  };

  const totalPortfolioValue = Object.entries(userBalance).reduce((acc: number, [tokenId, qty]) => {
      const token = tokens.find(t => t.id === tokenId);
      return acc + (token ? token.price * (qty as number) : 0);
  }, 0);

  return (
    <div className="space-y-6">
      {/* Portfolio Header */}
      <div className="bg-gradient-to-r from-slate-900 to-slate-800 p-6 rounded-2xl text-white shadow-lg relative overflow-hidden">
        <div className="relative z-10">
            <h2 className="text-sm text-slate-400 uppercase tracking-wider mb-1">Total Asset Value</h2>
            <div className="flex items-baseline gap-2">
                <h1 className="text-3xl font-bold">${totalPortfolioValue.toFixed(2)}</h1>
                <span className="text-green-400 text-sm flex items-center font-medium"><TrendingUp size={14} className="mr-1"/> +4.5%</span>
            </div>
            <div className="mt-4 flex gap-3">
                <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Deposit</button>
                <button className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Withdraw</button>
            </div>
        </div>
        <PieChart className="absolute right-4 bottom-4 text-slate-700 opacity-20" size={100} />
      </div>

      {/* Market List */}
      <div>
        <div className="flex justify-between items-center mb-3">
            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                <DollarSign className="text-blue-600" size={20} /> RWA Token Exchange
            </h3>
            <div className="flex items-center gap-2">
                <span className="text-[10px] text-slate-400 hidden sm:block">
                    Updated {lastUpdated.toLocaleTimeString()}
                </span>
                <button 
                onClick={fetchMarketData} 
                disabled={isLoading}
                className="flex items-center gap-2 text-xs font-medium bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-200 transition-all shadow-sm disabled:opacity-70 active:scale-95"
                title="Force refresh market data"
                >
                    <RefreshCw size={14} className={isLoading ? "animate-spin" : ""} />
                    {isLoading ? 'Syncing...' : 'Refresh Data'}
                </button>
            </div>
        </div>
        
        <div className="space-y-3">
            {tokens.map(token => {
                const soldPercentage = ((token.totalSupply - token.availableSupply) / token.totalSupply) * 100;
                const myQty = userBalance[token.id] || 0;

                return (
                <div key={token.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden">
                    <div className="flex justify-between items-start mb-2 relative z-10">
                        <div>
                            <div className="flex items-center gap-2">
                                <h4 className="font-bold text-slate-800">{token.name}</h4>
                                {myQty > 0 && <span className="text-[10px] bg-green-100 text-green-700 px-2 rounded-full">Owned: {myQty}</span>}
                            </div>
                            <p className="text-xs font-mono text-slate-500">{token.symbol}</p>
                        </div>
                        <div className="text-right">
                            <p className="font-bold text-slate-800">${token.price.toFixed(2)}</p>
                            <p className={`text-xs font-medium flex items-center justify-end ${token.change24h >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {token.change24h >= 0 ? <TrendingUp size={12} className="mr-1"/> : <TrendingDown size={12} className="mr-1"/>}
                                {token.change24h}%
                            </p>
                        </div>
                    </div>
                    
                    <p className="text-xs text-slate-600 mb-3 relative z-10">{token.description}</p>
                    
                    {/* Progress Bar for ICO/Funding */}
                    <div className="mb-3 relative z-10">
                        <div className="flex justify-between text-[10px] text-slate-500 mb-1">
                            <span>Sold: {soldPercentage.toFixed(1)}%</span>
                            <span>Total Supply: {token.totalSupply.toLocaleString()}</span>
                        </div>
                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div className="bg-blue-500 h-full rounded-full" style={{ width: `${soldPercentage}%` }}></div>
                        </div>
                    </div>

                    <div className="flex justify-between items-center pt-3 border-t border-slate-100 relative z-10">
                        <div className="text-xs text-slate-500">
                            APY: <span className="font-bold text-green-600">{token.yieldApy.toFixed(2)}%</span>
                        </div>
                        <button 
                            onClick={() => handleBuy(token.id)}
                            disabled={buyingId === token.id || token.availableSupply <= 0}
                            className="bg-blue-50 hover:bg-blue-100 text-blue-600 text-sm font-semibold px-4 py-1.5 rounded transition-colors flex items-center gap-2 disabled:opacity-50"
                        >
                            {buyingId === token.id ? <Loader2 size={14} className="animate-spin" /> : 'Buy 100'}
                        </button>
                    </div>
                </div>
            })}
        </div>
      </div>
    </div>
  );
};

export default RWAMarket;</code></pre>
        
        <div class="file-header">VideoFeed.tsx</div>
        <div class="file-path">components/VideoFeed.tsx</div>
        <pre><code>import React from 'react';
import { Aircraft } from '../types';
import { Scan, Target, AlertOctagon } from 'lucide-react';

interface VideoFeedProps {
  aircraft: Aircraft;
}

const VideoFeed: React.FC<VideoFeedProps> = ({ aircraft }) => {
  return (
    <div className={`relative rounded-lg overflow-hidden bg-black aspect-video group shadow-lg border transition-colors ${aircraft.status === 'EMERGENCY' ? 'border-red-600 ring-2 ring-red-500/50' : 'border-slate-700'}`}>
      {/* Simulated Video Background */}
      <img 
        src={aircraft.videoFeedUrl} 
        alt="Drone Feed" 
        className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
      />
      
      {/* HUD Overlay */}
      <div className="absolute inset-0 p-4 flex flex-col justify-between pointer-events-none">
        {/* Top HUD */}
        <div className="flex justify-between items-start text-xs font-mono text-green-400">
            <div className="bg-black/50 p-2 rounded backdrop-blur-sm border border-green-900/50">
                <p>CAM-01 • 1080p • 60FPS</p>
                <p>LAT: {aircraft.currentLocation.x.toFixed(4)} LON: {aircraft.currentLocation.y.toFixed(4)}</p>
            </div>
            <div className="bg-black/50 p-2 rounded backdrop-blur-sm border border-green-900/50 flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full animate-pulse ${aircraft.status === 'EMERGENCY' ? 'bg-red-500' : 'bg-green-500'}`}></div> 
                {aircraft.status === 'EMERGENCY' ? 'ALERT' : 'LIVE'}
            </div>
        </div>

        {/* Center Reticle */}
        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-50">
            {aircraft.status === 'EMERGENCY' ? (
                <AlertOctagon size={64} className="text-red-500 animate-ping" strokeWidth={1} />
            ) : (
                <Target size={48} className="text-white/80" strokeWidth={1} />
            )}
        </div>

        {/* Simulated AI Bounding Boxes */}
        {aircraft.status !== 'OFFLINE' && (
            <div className="absolute top-1/3 left-1/4 w-16 h-16 border border-yellow-400 rounded-sm opacity-70">
                 <span className="absolute -top-4 left-0 bg-yellow-400 text-black text-[8px] px-1 font-bold">OBSTACLE</span>
            </div>
        )}
        
        {/* Bottom HUD */}
        <div className="flex justify-between items-end text-green-400 text-xs font-mono">
             <div className="bg-black/50 p-2 rounded backdrop-blur-sm border border-green-900/50">
                <p>BAT: {aircraft.batteryLevel}%</p>
                <p>ALT: {aircraft.altitude?.toFixed(0) || 0}m</p>
                <p>SPD: {aircraft.speed?.toFixed(1) || 0}km/h</p>
             </div>
             <div className="flex items-center gap-2">
                {aircraft.status === 'EMERGENCY' ? (
                    <span className="text-red-500 font-bold animate-pulse">ERR: MALFUNCTION</span>
                ) : (
                    <>
                        <Scan className="animate-spin-slow" size={16} />
                        <span>AI SCANNING...</span>
                    </>
                )}
             </div>
        </div>
      </div>

      {/* Scanlines effect */}
      <div className="absolute inset-0 pointer-events-none" style={{
        background: 'linear-gradient(transparent 50%, rgba(0, 0, 0, 0.25) 50%)',
        backgroundSize: '100% 4px'
      }}></div>
    </div>
  );
};

export default VideoFeed;</code></pre>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Services -->
    <div id="services" class="section">
        <h2>服务 (services/)</h2>
        
        <div class="file-header">geminiService.ts</div>
        <div class="file-path">services/geminiService.ts</div>
        <pre><code>import { GoogleGenAI, Modality } from "@google/genai";

const API_KEY = process.env.API_KEY || '';

// Audio decoding helpers based on Google GenAI SDK recommendations
async function decodeAudioData(
  data: Uint8Array,
  ctx: AudioContext,
  sampleRate: number,
  numChannels: number,
): Promise<AudioBuffer> {
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}

function decode(base64: string) {
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

export const playTextToSpeech = async (text: string, voiceName: 'Kore' | 'Puck' | 'Fenrir' = 'Kore') => {
  if (!API_KEY) {
    console.error("API Key is missing");
    return;
  }

  try {
    const ai = new GoogleGenAI({ apiKey: API_KEY });
    
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash-preview-tts",
      contents: [{ parts: [{ text: text }] }],
      config: {
        responseModalities: [Modality.AUDIO],
        speechConfig: {
          voiceConfig: {
            prebuiltVoiceConfig: { voiceName: voiceName },
          },
        },
      },
    });

    const base64Audio = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

    if (!base64Audio) {
      throw new Error("No audio data received");
    }

    const outputAudioContext = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 24000 });
    const outputNode = outputAudioContext.createGain();
    
    const audioBuffer = await decodeAudioData(
      decode(base64Audio),
      outputAudioContext,
      24000,
      1,
    );

    const source = outputAudioContext.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(outputNode);
    outputNode.connect(outputAudioContext.destination);
    source.start();

    return source; // Return source to allow stopping if needed
  } catch (error) {
    console.error("Error generating speech:", error);
    throw error;
  }
};</code></pre>
        
        <div class="file-header">smartContractService.ts</div>
        <div class="file-path">services/smartContractService.ts</div>
        <pre><code>
import { RWAToken, Aircraft, Route } from '../types';
import { RWA_TOKENS } from './mockData';

/**
 * SmartContractService
 * 
 * Simulates interaction with an Ethereum/Polygon smart contract for RWA.
 * In a production app, this would use ethers.js or web3.js to talk to a real node.
 */

// In-memory ledger simulation
let ledgerTokens: RWAToken[] = [...RWA_TOKENS];
let userBalances: Record<string, Record<string, number>> = {
  'user-citizen': { 't-1': 10 } // Initial balance for demo
};

// Helpers
const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));
const generateAddress = () => '0x' + Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('');

export const smartContractService = {
  
  // 1. Fetch all available RWA tokens from the registry contract
  getAllTokens: async (): Promise<RWAToken[]> => {
    await delay(500); // Network latency
    return [...ledgerTokens];
  },

  // 2. Operator: "Mint" new tokens backed by an asset (Route/Aircraft)
  deployAssetToken: async (
    asset: Aircraft | Route, 
    valuation: number, 
    symbol: string,
    issuerId: string
  ): Promise<RWAToken> => {
    console.log(`[SmartContract] Deploying RWA contract for ${symbol}...`);
    await delay(1500); // Deployment taking place

    // Validate if asset is already tokenized
    const existing = ledgerTokens.find(t => t.assetId === asset.id);
    if (existing) {
      throw new Error(`Asset ${asset.id} is already tokenized as ${existing.symbol}`);
    }
    
    // Validate if symbol is taken
    if (ledgerTokens.some(t => t.symbol === symbol)) {
        throw new Error(`Symbol ${symbol} is already in use.`);
    }

    const totalSupply = Math.floor(valuation); // 1 token = $1 initial peg
    const assetName = 'name' in asset ? asset.name : asset.model;
    const contractAddr = generateAddress();
    const now = Date.now();

    const newToken: RWAToken = {
      id: `t-${now}`,
      assetId: asset.id,
      issuerId: issuerId,
      symbol: symbol.toUpperCase(),
      name: `${assetName} Revenue Share`,
      price: 1.00, // Initial Issue Price
      change24h: 0,
      marketCap: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(valuation),
      yieldApy: 5 + Math.random() * 5, // Initial estimated APY
      description: `Official revenue sharing token for ${assetName}. Holders receive dividends from flight operations linked to Smart Contract ${contractAddr.substring(0, 8)}...`,
      totalSupply: totalSupply,
      availableSupply: totalSupply, // All available at mint
      contractAddress: contractAddr,
      ownerCount: 1, // Issuer is first owner
      deploymentDate: now
    };

    ledgerTokens.unshift(newToken); // Add to top of ledger
    
    // Initialize issuer balance
    if (!userBalances[issuerId]) userBalances[issuerId] = {};
    userBalances[issuerId][newToken.id] = totalSupply;

    console.log(`[SmartContract] Contract deployed at ${contractAddr}`);
    return newToken;
  },

  // 3. Citizen: Buy tokens (Calls 'transfer' or 'mint' on contract)
  purchaseToken: async (userId: string, tokenId: string, amount: number): Promise<boolean> => {
    console.log(`[SmartContract] Processing purchase of ${amount} tokens for ${tokenId}`);
    await delay(1500); // Transaction confirmation time

    const tokenIndex = ledgerTokens.findIndex(t => t.id === tokenId);
    if (tokenIndex === -1) throw new Error("Token not found");

    const token = ledgerTokens[tokenIndex];

    if (token.availableSupply < amount) {
      throw new Error("Insufficient supply");
    }

    // Update Ledger State
    ledgerTokens[tokenIndex] = {
      ...token,
      availableSupply: token.availableSupply - amount,
      price: token.price * (1 + (0.0005 * amount)), // Dynamic Bonding curve
      ownerCount: (token.ownerCount || 0) + 1
    };

    // Update User Balance
    if (!userBalances[userId]) userBalances[userId] = {};
    userBalances[userId][tokenId] = (userBalances[userId][tokenId] || 0) + amount;

    return true;
  },

  // 4. Get User Balance
  getUserBalance: async (userId: string, tokenId: string): Promise<number> => {
    return userBalances[userId]?.[tokenId] || 0;
  },

  // 5. Simulate Revenue Distribution (Smart Contract Logic)
  distributeRevenue: async (tokenId: string, revenue: number) => {
    const token = ledgerTokens.find(t => t.id === tokenId);
    if (!token) return;

    console.log(`[SmartContract] Distributing $${revenue} revenue to holders of ${token.symbol}`);

    const yieldBoost = (revenue / token.totalSupply) * 200; 
    token.yieldApy = Math.min(120, (token.yieldApy || 5) + yieldBoost);
    
    const priceImpact = (revenue / token.totalSupply) * 2.5; 
    token.price = token.price + priceImpact;
    
    token.change24h = parseFloat((token.change24h + (yieldBoost / 2)).toFixed(2));
  },

  // 6. Process Asset Revenue (Linker)
  recordAssetRevenue: async (assetId: string, revenue: number) => {
    const token = ledgerTokens.find(t => t.assetId === assetId);
    if (token) {
        await smartContractService.distributeRevenue(token.id, revenue);
    }
  },

  // 7. Simulate Market Activity (Random Fluctuation)
  simulateMarketActivity: async () => {
    // Introduces small micro-fluctuations to simulate an active order book
    ledgerTokens.forEach(token => {
      const volatility = 0.005; // 0.5% max swing
      const change = 1 + ((Math.random() * volatility * 2) - volatility);
      
      // Update price
      token.price = Math.max(0.01, token.price * change);
      
      // Update market cap display
      token.marketCap = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })
        .format(token.price * token.totalSupply);

      // Update 24h change slightly to match trend
      const changeDelta = (change - 1) * 100;
      token.change24h = parseFloat((token.change24h + changeDelta).toFixed(2));
    });
  }
};</code></pre>
        
        <div class="file-header">mockData.ts</div>
        <div class="file-path">services/mockData.ts</div>
        <pre><code>import { Route, Aircraft, Order, OrderStatus, Alert, RWAToken, NoFlyZone, InsuranceClaim } from '../types';

export const ROUTES: Route[] = [
  {
    id: 'r-1',
    name: 'Skyline Scenic Tour',
    startPoint: 'Downtown Heliport',
    endPoint: 'Bay View Park',
    durationMinutes: 15,
    price: 150,
    distanceKm: 12,
    coordinates: [{x: 20, y: 80}, {x: 40, y: 60}, {x: 60, y: 30}]
  },
  {
    id: 'r-2',
    name: 'Airport Express Shuttle',
    startPoint: 'City Center',
    endPoint: 'Intl Airport',
    durationMinutes: 8,
    price: 95,
    distanceKm: 18,
    coordinates: [{x: 50, y: 50}, {x: 80, y: 80}]
  },
  {
    id: 'r-3',
    name: 'Medical Emergency Corridor',
    startPoint: 'General Hospital',
    endPoint: 'Northside Clinic',
    durationMinutes: 5,
    price: 200,
    distanceKm: 8,
    coordinates: [{x: 10, y: 10}, {x: 30, y: 20}]
  }
];

export const AIRCRAFT: Aircraft[] = [
  {
    id: 'ac-001',
    model: 'EHang 216',
    regNumber: 'UAM-NY-01',
    status: 'AVAILABLE',
    operator: 'SkyHigh Ops',
    batteryLevel: 85,
    currentLocation: { x: 20, y: 80 },
    videoFeedUrl: 'https://images.unsplash.com/photo-1473968512647-3e447244af8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
    speed: 0,
    altitude: 0
  },
  {
    id: 'ac-002',
    model: 'Joby S4',
    regNumber: 'UAM-NY-02',
    status: 'BUSY',
    operator: 'Urban Wings',
    batteryLevel: 62,
    currentLocation: { x: 45, y: 55 },
    videoFeedUrl: 'https://images.unsplash.com/photo-1551516594-56cb7830558c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
    speed: 145,
    altitude: 450
  },
  {
    id: 'ac-003',
    model: 'Volocopter 2X',
    regNumber: 'UAM-NY-03',
    status: 'MAINTENANCE',
    operator: 'SkyHigh Ops',
    batteryLevel: 10,
    currentLocation: { x: 90, y: 90 },
    videoFeedUrl: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
    speed: 0,
    altitude: 0
  }
];

export const INITIAL_ORDERS: Order[] = [
  {
    id: 'ord-1001',
    userId: 'u-1',
    routeId: 'r-1',
    aircraftId: 'ac-001',
    status: OrderStatus.COMPLETED,
    timestamp: Date.now() - 86400000,
    amount: 150,
    txHash: '0x71c...9a2'
  },
  {
    id: 'ord-1002',
    userId: 'u-1',
    routeId: 'r-2',
    status: OrderStatus.PENDING,
    timestamp: Date.now() - 3600000,
    amount: 95,
  }
];

export const ALERTS: Alert[] = [
  {
    id: 'al-1',
    severity: 'MEDIUM',
    message: 'UAM-NY-02 deviated slightly from corridor',
    timestamp: Date.now() - 120000,
    status: 'OPEN',
    aircraftId: 'ac-002'
  },
  {
    id: 'al-2',
    severity: 'LOW',
    message: 'UAM-NY-03 maintenance schedule overdue',
    timestamp: Date.now() - 5000000,
    status: 'OPEN',
    aircraftId: 'ac-003'
  }
];

export const RWA_TOKENS: RWAToken[] = [
  {
    id: 't-1',
    assetId: 'r-1',
    issuerId: 'SkyHigh Ops',
    symbol: 'SKY-R1',
    name: 'Scenic Route Data Fund',
    price: 12.45,
    change24h: 2.3,
    marketCap: '$1.2M',
    yieldApy: 8.5,
    description: 'Fractional ownership of flight data revenue from the Skyline Scenic Tour route.',
    totalSupply: 100000,
    availableSupply: 45000
  },
  {
    id: 't-2',
    assetId: 'infra-1',
    issuerId: 'City Govt',
    symbol: 'UAM-INFRA',
    name: 'City Vertiport Bond',
    price: 98.20,
    change24h: 0.1,
    marketCap: '$45M',
    yieldApy: 4.2,
    description: 'Tokenized debt instrument funding new vertiport infrastructure in District 9.',
    totalSupply: 500000,
    availableSupply: 120000
  },
  {
    id: 't-3',
    assetId: 'fleet-a',
    issuerId: 'Urban Wings',
    symbol: 'DRONE-IDX',
    name: 'Autonomous Fleet Index',
    price: 156.00,
    change24h: -1.2,
    marketCap: '$8.5M',
    yieldApy: 6.8,
    description: 'Basket token representing the aggregate performance of 50+ commercial drones.',
    totalSupply: 50000,
    availableSupply: 2000
  }
];

export const NO_FLY_ZONES: NoFlyZone[] = [
  { id: 'nfz-1', x: 50, y: 50, radius: 10, reason: 'Military Base' },
  { id: 'nfz-2', x: 80, y: 20, radius: 8, reason: 'High Rise Construction' }
];

export const INSURANCE_CLAIMS: InsuranceClaim[] = [
  {
    id: 'clm-001',
    aircraftId: 'ac-003',
    incidentDate: Date.now() - 100000000,
    description: 'Rotor damage during high wind landing.',
    status: 'APPROVED',
    amount: 2500
  }
];</code></pre>
        
        <div class="file-header">pathUtils.ts</div>
        <div class="file-path">services/pathUtils.ts</div>
        <pre><code>import { Coordinate, NoFlyZone } from '../types';

// Simple Grid-based pathfinding (simulating complex auto-routing)
export const findOptimalPath = (start: Coordinate, end: Coordinate, noFlyZones: NoFlyZone[]): Coordinate[] => {
  const GRID_SIZE = 100; // 100x100 virtual grid
  
  // Check if point is in any no-fly zone
  const isInNoFlyZone = (x: number, y: number) => {
    return noFlyZones.some(zone => {
      const dx = x - zone.x;
      const dy = y - zone.y;
      return Math.sqrt(dx * dx + dy * dy) < zone.radius;
    });
  };

  // A* / BFS Simplified Implementation
  // For this demo, we will do a simplified direct path with waypoints if blocked
  // This simulates "Auto Planning" without heavy computation for the browser
  
  const path: Coordinate[] = [start];
  let current = { ...start };
  
  const steps = 20;
  const dx = (end.x - start.x) / steps;
  const dy = (end.y - start.y) / steps;
  
  // Naive straight line generation first
  for (let i = 1; i < steps; i++) {
    const nextX = start.x + dx * i;
    const nextY = start.y + dy * i;
    
    if (isInNoFlyZone(nextX, nextY)) {
      // If blocked, detour! 
      // Simple detour logic: try moving perpendicular to the blockage
      // In a real app, this would be A* or Dijkstra
      const detourX = nextX + (dy * 5); // Perpendicular shift
      const detourY = nextY - (dx * 5);
      
      if (!isInNoFlyZone(detourX, detourY)) {
         path.push({ x: detourX, y: detourY });
      } else {
         // Try other side
         path.push({ x: nextX - (dy * 5), y: nextY + (dx * 5) });
      }
    } else {
      path.push({ x: nextX, y: nextY });
    }
  }
  
  path.push(end);
  return path;
};</code></pre>
        
        <div class="file-header">opsApi.ts</div>
        <div class="file-path">services/opsApi.ts</div>
        <pre><code>import type { Mission, MissionEventType } from '../types';

const DEFAULT_BASE = 'http://localhost:3001';

function baseUrl() {
  // Vite env var
  const v = (import.meta as any)?.env?.VITE_OPS_API_BASE_URL;
  return (typeof v === 'string' && v.length > 0) ? v : DEFAULT_BASE;
}

async function http<T>(path: string, init?: RequestInit): Promise<T> {
  const res = await fetch(`${baseUrl()}${path}`, {
    ...init,
    headers: {
      'Content-Type': 'application/json',
      ...(init?.headers || {})
    }
  });

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error(`Ops API error ${res.status}: ${text || res.statusText}`);
  }

  return (await res.json()) as T;
}

export const opsApi = {
  createMission: async (input: { userId: string; routeId: string; operatorId?: string }): Promise<Mission> => {
    return await http<Mission>('/api/events/mission-created', {
      method: 'POST',
      body: JSON.stringify(input)
    });
  },

  sendMissionEvent: async (
    missionId: string,
    event: MissionEventType,
    payload?: Record<string, unknown>
  ): Promise<Mission> => {
    return await http<Mission>(`/api/events/${encodeURIComponent(missionId)}/${encodeURIComponent(event)}`, {
      method: 'POST',
      body: JSON.stringify(payload || {})
    });
  },

  listMissions: async (): Promise<Mission[]> => {
    return await http<Mission[]>('/api/missions');
  }
};</code></pre>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Backend -->
    <div id="backend" class="section">
        <h2>后端服务 (backend/)</h2>
        
        <div class="file-header">domain.ts</div>
        <div class="file-path">backend/src/domain.ts</div>
        <pre><code>export type MissionState =
  | 'Created'
  | 'Scheduled'
  | 'Active'
  | 'Completed'
  | 'Delayed'
  | 'Failed';

export type PersistenceMode = 'off' | 'devnet' | 'l2' | 'l1';

export type MissionEventType =
  | 'MISSION_CREATED'
  | 'MISSION_SCHEDULED'
  | 'MISSION_STARTED'
  | 'MISSION_DELAYED'
  | 'MISSION_FAILED'
  | 'MISSION_COMPLETED';

export interface MissionTimestamps {
  createdAt: number;
  scheduledAt?: number;
  startedAt?: number;
  endedAt?: number;
  lastUpdatedAt: number;
}

export interface Mission {
  id: string;
  userId: string;
  routeId: string;
  operatorId?: string;
  aircraftId?: string;

  state: MissionState;
  timestamps: MissionTimestamps;

  // Operational indicators (for experiments/analytics)
  riskScore: number; // 0..1
  valueScore: number; // abstract operational value

  // Optional persistence metadata
  persistence?: {
    mode: PersistenceMode;
    lastTxHash?: string;
    lastFinalitySeconds?: number;
  };
}

export interface MissionEvent {
  id: string;
  missionId: string;
  type: MissionEventType;
  occurredAt: number;
  payload?: Record<string, unknown>;
}</code></pre>
        
        <div class="file-header">mission-state-machine.ts</div>
        <div class="file-path">backend/src/mission-state-machine.ts</div>
        <pre><code>import type { MissionEventType, MissionState } from './domain.js';

const TRANSITIONS: Record<MissionState, Partial<Record<MissionEventType, MissionState>>> = {
  Created: {
    MISSION_SCHEDULED: 'Scheduled',
    MISSION_FAILED: 'Failed'
  },
  Scheduled: {
    MISSION_STARTED: 'Active',
    MISSION_DELAYED: 'Delayed',
    MISSION_FAILED: 'Failed'
  },
  Active: {
    MISSION_COMPLETED: 'Completed',
    MISSION_DELAYED: 'Delayed',
    MISSION_FAILED: 'Failed'
  },
  Delayed: {
    MISSION_STARTED: 'Active',
    MISSION_COMPLETED: 'Completed',
    MISSION_FAILED: 'Failed'
  },
  Completed: {},
  Failed: {}
};

export function transitionState(current: MissionState, eventType: MissionEventType): MissionState {
  const next = TRANSITIONS[current]?.[eventType];
  if (!next) {
    throw new Error(`Invalid transition: ${current} + ${eventType}`);
  }
  return next;
}

export function isTerminal(state: MissionState): boolean {
  return state === 'Completed' || state === 'Failed';
}</code></pre>
        
        <div class="file-header">mission.service.ts</div>
        <div class="file-path">backend/src/mission.service.ts</div>
        <pre><code>import { Injectable } from '@nestjs/common';
import type { Mission, MissionEvent, MissionEventType, MissionState } from './domain.js';
import { transitionState } from './mission-state-machine.js';
import { PersistenceAdapter } from './persistence-adapter.js';

function now() {
  return Date.now();
}

function randomId(prefix: string) {
  return `${prefix}-${now()}-${Math.floor(Math.random() * 1e6)}`;
}

function clamp01(x: number) {
  return Math.max(0, Math.min(1, x));
}

@Injectable()
export class MissionService {
  private readonly missions = new Map<string, Mission>();
  private readonly events: MissionEvent[] = [];
  private readonly persistence = PersistenceAdapter.fromEnv();

  listMissions(state?: MissionState): Mission[] {
    const all = [...this.missions.values()];
    return state ? all.filter((m) => m.state === state) : all;
  }

  getMission(id: string): Mission | undefined {
    return this.missions.get(id);
  }

  createMission(input: { userId: string; routeId: string; operatorId?: string }): Mission {
    const createdAt = now();
    const riskScore = clamp01(0.15 + Math.random() * 0.55);
    const valueScore = Math.max(0, 50 + (Math.random() * 200));

    const mission: Mission = {
      id: randomId('m'),
      userId: input.userId,
      routeId: input.routeId,
      operatorId: input.operatorId,
      state: 'Created',
      timestamps: {
        createdAt,
        lastUpdatedAt: createdAt
      },
      riskScore,
      valueScore,
      persistence: { mode: this.persistence.getMode() }
    };

    this.missions.set(mission.id, mission);
    // Emit initial event
    void this.applyEvent(mission.id, 'MISSION_CREATED', { routeId: mission.routeId, userId: mission.userId });

    return mission;
  }

  async applyEvent(missionId: string, type: MissionEventType, payload?: Record<string, unknown>): Promise<Mission> {
    const m = this.missions.get(missionId);
    if (!m) throw new Error(`Mission not found: ${missionId}`);

    const occurredAt = now();

    // Allow event payload to enrich operational fields (kept off-chain by default)
    if (payload) {
      const operatorId = payload['operatorId'];
      const aircraftId = payload['aircraftId'];
      if (typeof operatorId === 'string') m.operatorId = operatorId;
      if (typeof aircraftId === 'string') m.aircraftId = aircraftId;
    }

    // Map event to state transitions (Created is initial state)
    if (type !== 'MISSION_CREATED') {
      const next = transitionState(m.state, type);
      m.state = next;
    }

    // Timestamp bookkeeping
    if (type === 'MISSION_SCHEDULED') m.timestamps.scheduledAt = occurredAt;
    if (type === 'MISSION_STARTED') m.timestamps.startedAt = occurredAt;
    if (type === 'MISSION_COMPLETED' || type === 'MISSION_FAILED') m.timestamps.endedAt = occurredAt;
    m.timestamps.lastUpdatedAt = occurredAt;

    // Persist (optional / async)
    const persistenceResult = await this.persistence.recordMissionState(missionId, m.state);
    if (persistenceResult && m.persistence) {
      m.persistence.lastTxHash = persistenceResult.txHash;
      m.persistence.lastFinalitySeconds = persistenceResult.finalitySeconds;
    }

    const evt: MissionEvent = {
      id: randomId('e'),
      missionId,
      type,
      occurredAt,
      payload
    };

    this.events.push(evt);

    return m;
  }

  listEvents(missionId?: string): MissionEvent[] {
    return missionId ? this.events.filter((e) => e.missionId === missionId) : [...this.events];
  }
}</code></pre>
        
        <div class="file-header">mission.controller.ts</div>
        <div class="file-path">backend/src/mission.controller.ts</div>
        <pre><code>import { Body, Controller, Get, Param, Post, Query } from '@nestjs/common';
import type { Mission, MissionEvent, MissionEventType, MissionState } from './domain.js';
import { MissionService } from './mission.service.js';

@Controller()
export class MissionController {
  constructor(private readonly missions: MissionService) {}

  // Paper-style event ingestion endpoints
  @Post('api/events/mission-created')
  createEventCreated(@Body() body: { userId: string; routeId: string; operatorId?: string }): Mission {
    return this.missions.createMission(body);
  }

  @Post('api/events/:missionId/:event')
  async ingestEvent(
    @Param('missionId') missionId: string,
    @Param('event') event: string,
    @Body() payload?: Record<string, unknown>
  ): Promise<Mission> {
    const type = normalizeEvent(event);
    return await this.missions.applyEvent(missionId, type, payload);
  }

  // Convenience REST endpoints
  @Get('api/missions')
  list(@Query('state') state?: MissionState): Mission[] {
    return this.missions.listMissions(state);
  }

  @Get('api/missions/:missionId')
  get(@Param('missionId') missionId: string): Mission {
    const m = this.missions.getMission(missionId);
    if (!m) throw new Error('NotFound');
    return m;
  }

  @Get('api/events')
  listEvents(@Query('missionId') missionId?: string): MissionEvent[] {
    return this.missions.listEvents(missionId);
  }
}

function normalizeEvent(event: string): MissionEventType {
  const key = event.toUpperCase();
  const allowed: Record<string, MissionEventType> = {
    'MISSION_SCHEDULED': 'MISSION_SCHEDULED',
    'MISSION_STARTED': 'MISSION_STARTED',
    'MISSION_DELAYED': 'MISSION_DELAYED',
    'MISSION_FAILED': 'MISSION_FAILED',
    'MISSION_COMPLETED': 'MISSION_COMPLETED'
  };
  const mapped = allowed[key];
  if (!mapped) throw new Error(`Unsupported event: ${event}`);
  return mapped;
}</code></pre>
        
        <div class="file-header">persistence-adapter.ts</div>
        <div class="file-path">backend/src/persistence-adapter.ts</div>
        <pre><code>import type { MissionState, PersistenceMode } from './domain.js';

export interface PersistenceResult {
  txHash: string;
  finalitySeconds: number;
}

const delay = (ms: number) => new Promise((r) => setTimeout(r, ms));

function randomHex(n: number) {
  const chars = '0123456789abcdef';
  let s = '';
  for (let i = 0; i < n; i++) s += chars[Math.floor(Math.random() * chars.length)];
  return s;
}

export class PersistenceAdapter {
  constructor(private readonly mode: PersistenceMode) {}

  getMode() {
    return this.mode;
  }

  async recordMissionState(missionId: string, state: MissionState): Promise<PersistenceResult | null> {
    if (this.mode === 'off') return null;

    // Simulated finality to match the paper narrative (ms-level ops, sec-level chain finality)
    const finalitySeconds =
      this.mode === 'devnet' ? 0.08 : this.mode === 'l2' ? 2.3 : 13.5;

    // Simulate async submission + confirmation
    await delay(Math.max(20, finalitySeconds * 100));

    return {
      txHash: `0x${randomHex(64)}`,
      finalitySeconds
    };
  }

  static fromEnv(): PersistenceAdapter {
    const mode = (process.env.PERSISTENCE_MODE || 'off') as PersistenceMode;
    if (!['off', 'devnet', 'l2', 'l1'].includes(mode)) {
      throw new Error(`Invalid PERSISTENCE_MODE: ${process.env.PERSISTENCE_MODE}`);
    }
    return new PersistenceAdapter(mode);
  }
}</code></pre>
        
        <div class="file-header">app.module.ts</div>
        <div class="file-path">backend/src/app.module.ts</div>
        <pre><code>import { Module } from '@nestjs/common';
import { MissionController } from './mission.controller.js';
import { MissionService } from './mission.service.js';

@Module({
  controllers: [MissionController],
  providers: [MissionService]
})
export class AppModule {}</code></pre>
        
        <div class="file-header">main.ts</div>
        <div class="file-path">backend/src/main.ts</div>
        <pre><code>import 'reflect-metadata';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module.js';

const PORT = Number(process.env.PORT || 3001);

async function bootstrap() {
  const app = await NestFactory.create(AppModule, { cors: true });

  await app.listen(PORT);
  // eslint-disable-next-line no-console
  console.log(`[OpsService] listening on http://localhost:${PORT}`);
  // eslint-disable-next-line no-console
  console.log(`[OpsService] PERSISTENCE_MODE=${process.env.PERSISTENCE_MODE || 'off'}`);
}

bootstrap();</code></pre>
        
        <div class="file-header">package.json</div>
        <div class="file-path">backend/package.json</div>
        <pre><code>{
  "name": "skynet-uam-ops-service",
  "version": "0.1.0",
  "private": true,
  "license": "Apache-2.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch --loader ts-node/esm src/main.ts",
    "build": "tsc -p tsconfig.json",
    "start": "node dist/main.js",
    "test": "node --test"
  },
  "dependencies": {
    "@nestjs/common": "^10.4.8",
    "@nestjs/core": "^10.4.8",
    "@nestjs/platform-express": "^10.4.8",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "ts-node": "^10.9.2",
    "typescript": "~5.8.2"
  }
}</code></pre>
    </div>
    
    <div class="footer">
        <p>SkyNetUAM Platform - 完整代码文档</p>
        <p>生成时间: <span id="footer-date"></span></p>
        <p>© 2025 SkyNet Research Team</p>
    </div>
    
    <script>
        const now = new Date();
        document.getElementById('date').textContent = now.toLocaleString('zh-CN');
        document.getElementById('footer-date').textContent = now.toLocaleString('zh-CN');
    </script>
</body>
</html>
